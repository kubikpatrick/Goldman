@page "/"

@attribute [Authorize]

@using Community.Blazor.MapLibre
@using Community.Blazor.MapLibre.Models
@using Community.Blazor.MapLibre.Models.Camera
@using Community.Blazor.MapLibre.Models.Control
@using Community.Blazor.MapLibre.Models.Marker

@using Goldman.Models
@using Goldman.Models.Devices
@using Goldman.Web.Services
@using Goldman.Web.Components

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client

@using MudBlazor

@inject HttpClient Http
@inject TokenService TokenService
@inject ServerUrlService ServerUrlService
@inject IGeolocationService GeolocationService

<PageTitle>Home</PageTitle>

<div class="row g-0">
    <div class="d-none d-md-block col-0 col-sm-3 col-md-2">
        <MudTabs Ripple="false" Centered="true" MinimumTabWidth="0%" Outlined="true" Rounded="true" Color="Color.Info" Border="false">
            <MudTabPanel Text="Devices">
                @if (devices is null)
                {
                    <Spinner />
                }
                else
                {
                    @if (devices.Count == 0)
                    {
                        <p>No devices added.</p>
                    }
                    else
                    {
                        <MudGrid Class="p-2" Spacing="2">
                            @foreach (var device in devices.OrderByDescending(d => d.Location.Timestamp))
                            {
                                <MudItem xs="12">
                                    <DeviceCard Device="device" CurrentLocation="currentLocation" OnClick="@(() => MoveToAsync(device.Location))" />
                                </MudItem>
                            }
                        </MudGrid>
                    }
                }
            </MudTabPanel>

            <MudTabPanel Text="Groups">
                <p>Not finished.</p>
            </MudTabPanel>
        </MudTabs>
    </div>
    
    <div class="col-12 col-sm-9 col-md-10">
        <MapLibre @ref="map" Options="options" Class="w-100 vh-100" OnLoad="@OnMapInitializedAsync"/>
    </div>
</div>

@code
{
    private MapLibre map = new MapLibre();
    private MapOptions options = new MapOptions
    {
        MaxZoom = 23,
        MinZoom = 2,
        Zoom = 2,
        Style = "style.json",
        CanvasContextAttributes = new WebGLContextAttributes
        {
            Antialias = true,
            ContextType = "webgl2"
        }
    };

    private HubConnection connection;
    private List<Device>? devices;
    private Location? currentLocation;
    private string serverUrl;
    
    private MarkerService MarkerService => new MarkerService(map);

    protected override async Task OnInitializedAsync()
    {
        serverUrl = await ServerUrlService.GetServerUrlAsync();
        GeolocationService.GetCurrentPosition(location =>
        {
            currentLocation = new Location
            {
                Longitude = location.Coords.Longitude,
                Latitude = location.Coords.Latitude
            };
        });
        
        await FetchDataAsync();
        await CreateRealTimeConnectionAsync();
    }

    private async Task FetchDataAsync()
    {
        devices = await Http.GetFromJsonAsync<List<Device>>($"{serverUrl}/devices");
    }

    private async Task CreateRealTimeConnectionAsync()
    {
        connection = new HubConnectionBuilder()
            .WithUrl($"{serverUrl}/hubs/location", configuration =>
            {
                configuration.AccessTokenProvider = async () => await TokenService.GetTokenAsync();
            })
            .WithAutomaticReconnect()
            .Build();

        connection.On<string, Location>(EventNames.InZone, async (id, location) =>
        {
            await MarkerService.MoveMarkerAsync(id, location);
        });
        
        await connection.StartAsync();
    }

    private async Task OnMapInitializedAsync(EventArgs arg)
    {
        foreach (var device in devices)
        {
            await AddMarkerAsync(device);
        }
        
        await map.AddControl(ControlType.NavigationControl, ControlPosition.TopRight);
        await map.AddControl(ControlType.GlobeControl, ControlPosition.TopRight);
        await map.AddControl(ControlType.GeolocateControl, ControlPosition.TopRight);

    }

    private async Task AddMarkerAsync(Device device)
    {
        string path = device.Type switch
        {
            DeviceType.Computer => "/images/computer.png",
            DeviceType.Phone => "/images/smartphone.png",
            _ => throw new ArgumentOutOfRangeException()
        };
        
        await MarkerService.AddMarkerAsync(device.Id, device.Location, new MarkerOptions
        {
            OpacityWhenCovered = "0",
            Extensions = new MarkerOptionsExtensions
            {
                HtmlContent = $"""<div class="d-flex justify-content-center align-items-center rounded-circle border border-2 border-light-subtle bg-white" style="width: 50px; height: 50px;"><img src="{path}" class="rounded-circle" style="width: 32px; height: 32px;"></div>"""
            }
        });
    }

    private async Task MoveToAsync(Location location)
    {
        await map.FlyTo(new FlyToOptions
        {
            Center = new LngLat(location.Longitude, location.Latitude),
            Essential = true,
            Zoom = 16
        });
    }
}